#!/bin/bash

npm test

gpg --delete-secret-keys ebak
gpg --delete-keys ebak
gpg --list-keys
gpg --quick-gen-key 'ebak'


rm -rf   /tmp/ebak-data
rm -rf   /tmp/ebak-config
mkdir -p /tmp/ebak-data/matt_first
mkdir -p /tmp/ebak-data/jim_leach

# For S3
export REMOTE="s3://ebak-$(date +%F)"
# For Files
export REMOTE='file:///tmp/ebak-repo'

if [ $(echo "$REMOTE" | grep '^s3' | wc -c) -gt 0 ]; then
    aws s3 rb --force "$REMOTE"
    aws s3 mb "$REMOTE"
    # You need to empty the bucket...
else
    rm -rf $( echo "$REMOTE" | sed 's%^[a-z0-9]\+\://%%' )
fi

# For Local

node dist/src/index.js init --local-config=/tmp/ebak-config/matt_first mattfirst /tmp/ebak-data/matt_first ebak "$REMOTE"

node dist/src/index.js upload --local-config=/tmp/ebak-config/matt_first /tmp/ebak-data/matt_first

# Data should be empty
find /tmp/ebak-data/matt_first
# Only config file should exist
find /tmp/ebak-config/matt_first

cp -R test/data/my-projects /tmp/ebak-data/matt_first

# There should be files for each project (7) under my-projects
find /tmp/ebak-data/matt_first

node dist/src/index.js upload --local-config=/tmp/ebak-config/matt_first /tmp/ebak-data/matt_first

# There should be one or more commit file and a tmp directory too
find /tmp/ebak-config/matt_first

# There should be a filepart for every project (7) as well a a commit file... all encrypted
if [ $(echo "$REMOTE" | grep '^s3' | wc -c) -gt 0 ]; then
    aws s3 ls "$REMOTE"
else
    ls $( echo "$REMOTE" | sed 's%^[a-z0-9]\+\://%%' )
fi

node dist/src/index.js init --local-config=/tmp/ebak-config/jim_leach jimleach /tmp/ebak-data/jim_leach ebak "$REMOTE"

node dist/src/index.js fetch --local-config=/tmp/ebak-config/jim_leach /tmp/ebak-data/jim_leach

# They should have the same contents...
ls -alh /tmp/ebak-config/jim_leach/remote-pending-commit/ /tmp/ebak-config/matt_first/commit/

# There should be one remote-pending-commit
find /tmp/ebak-config/jim_leach

# And no files in here
find /tmp/ebak-data/jim_leach

node dist/src/index.js download --local-config=/tmp/ebak-config/jim_leach /tmp/ebak-data/jim_leach

# There should now be files in here
find /tmp/ebak-data/jim_leach

# And the remote-pending-commit should have become remote-commit
find /tmp/ebak-config/jim_leach

# node dist/src/index.js download --local-config=/tmp/ebak-config/matt_first /tmp/ebak-data/matt_first
#
# mkdir /tmp/ebak-data/jim_leach/my-projects/
#
# cp test/data/my-projects/t-fp-merge.md  /tmp/ebak-data/jim_leach/my-projects/
#
