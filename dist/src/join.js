"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const ramda_1 = require("ramda");
const stronger_typed_streams_1 = require("stronger-typed-streams");
var stronger_typed_streams_2 = require("stronger-typed-streams");
exports.Duplex = stronger_typed_streams_2.Duplex;
exports.Writable = stronger_typed_streams_2.Writable;
exports.Transform = stronger_typed_streams_2.Transform;
exports.Readable = stronger_typed_streams_2.Readable;
const streamdash_1 = require("streamdash");
class MemoryJoinStorage {
    constructor() {
        this.obs = [];
    }
    find(qry, next) {
        next(null, this.obs.filter((o) => {
            return ramda_1.equals(o, ramda_1.merge(o, qry));
        }));
    }
    add(t, next) {
        this.obs.push(t);
        next();
    }
}
exports.MemoryJoinStorage = MemoryJoinStorage;
class MemoryKVStore {
    constructor() {
        this.data = [];
    }
    get(k, next) {
        let r = this.data.filter(({ k: myK }) => {
            return ramda_1.equals(myK, k);
        }).map(({ v }) => v);
        if (r.length) {
            return next(null, r[0]);
        }
        return next(null, null);
    }
    add(k, v, next) {
        this.data = this.data.filter(({ k: myK }) => {
            return !ramda_1.equals(myK, k);
        });
        this.data.push({ k, v });
        next(null);
    }
}
exports.MemoryKVStore = MemoryKVStore;
var LeftOrRight;
(function (LeftOrRight) {
    LeftOrRight[LeftOrRight["Left"] = 1] = "Left";
    LeftOrRight[LeftOrRight["Right"] = 2] = "Right";
})(LeftOrRight = exports.LeftOrRight || (exports.LeftOrRight = {}));
class JoinTransform extends stronger_typed_streams_1.Transform {
    constructor(leftOrRight, lToQrys, rToQrys, opts) {
        super(opts);
        this.leftStorage = new MemoryJoinStorage();
        this.rightStorage = new MemoryJoinStorage();
        this.leftOrRight = leftOrRight;
        this.lToQrys = lToQrys;
        this.rToQrys = rToQrys;
    }
    doQry({ lQry, rQry }, next) {
        let r = {};
        let isDone = (a) => {
            return (Object.keys(a).length == 2);
        };
        let perhaps = (e) => {
            if (e) {
                return next(e);
            }
            if (isDone(r)) {
                next(null, r);
            }
        };
        this.leftStorage.find(lQry, (e, items) => {
            r.l = items;
            perhaps(e);
        });
        this.rightStorage.find(rQry, (e, items) => {
            r.r = items;
            perhaps(e);
        });
    }
    _transform(a, encoding, cb) {
        let qry = this.leftOrRight(a) == LeftOrRight.Left ?
            this.lToQrys(a) :
            this.rToQrys(a);
        let stored = (e) => {
            if (e) {
                return cb(e);
            } // TODO: Test Errors
            this.doQry(qry, (e, r) => {
                if (e) {
                    return cb(e);
                } // TODO: Test Errors
                this.push(r);
                cb();
            });
        };
        if (this.leftOrRight(a) == LeftOrRight.Left) {
            return this.leftStorage.add(a, stored);
        }
        this.rightStorage.add(a, stored);
    }
}
exports.JoinTransform = JoinTransform;
class InnerJoinTransform extends stronger_typed_streams_1.Transform {
    constructor(merge, indexer, opts) {
        super(opts);
        this.joinStorage = new MemoryKVStore();
        this.merge = merge;
        this.indexer = indexer;
    }
    _transform(a, encoding, cb) {
        let worker = ([l, r], cb) => {
            let v = this.merge(l, r);
            let k = this.indexer(v);
            this.joinStorage.get(k, (e, o) => {
                if (e) {
                    return cb(e);
                }
                if (o !== null) {
                    return cb(null, []);
                }
                this.joinStorage.add(k, v, (e) => {
                    cb(null, [v]);
                });
            });
        };
        let pairs = ramda_1.xprod(a.l, a.r);
        streamdash_1.asyncMap(worker, pairs, (e, os) => {
            if (e) {
                return cb(e);
            }
            if (os.length > 0) {
                ramda_1.flatten(os).map((o) => {
                    this.push(o);
                });
            }
            return cb();
        });
        // pairs.map(this.worker);
    }
}
exports.InnerJoinTransform = InnerJoinTransform;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiam9pbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9qb2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsaUNBQXNEO0FBQ3RELG1FQUFtRDtBQUNuRCxpRUFBK0U7QUFBdEUsMENBQUEsTUFBTSxDQUFBO0FBQUUsNENBQUEsUUFBUSxDQUFBO0FBQUUsNkNBQUEsU0FBUyxDQUFBO0FBQUUsNENBQUEsUUFBUSxDQUFBO0FBQzlDLDJDQUFzQztBQU90QztJQUFBO1FBRVksUUFBRyxHQUFRLEVBQUUsQ0FBQztJQVkxQixDQUFDO0lBVkcsSUFBSSxDQUFDLEdBQWUsRUFBRSxJQUFtQjtRQUNyQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDN0IsTUFBTSxDQUFDLGNBQU0sQ0FBQyxDQUFDLEVBQUUsYUFBSyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDUixDQUFDO0lBRUQsR0FBRyxDQUFDLENBQUksRUFBRSxJQUF3QjtRQUM5QixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQixJQUFJLEVBQUUsQ0FBQztJQUNYLENBQUM7Q0FDSjtBQWRELDhDQWNDO0FBT0Q7SUFBQTtRQUVZLFNBQUksR0FBbUIsRUFBRSxDQUFDO0lBaUJ0QyxDQUFDO0lBZkcsR0FBRyxDQUFDLENBQUksRUFBRSxJQUFzQjtRQUM1QixJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBQyxFQUFFLEVBQUU7WUFDbEMsTUFBTSxDQUFDLGNBQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDMUIsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBQyxDQUFDLEVBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUFDLENBQUM7UUFDMUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELEdBQUcsQ0FBQyxDQUFJLEVBQUUsQ0FBSSxFQUFFLElBQXdCO1FBQ3BDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFDLENBQUMsRUFBRSxHQUFHLEVBQUMsRUFBRSxFQUFFO1lBQ3RDLE1BQU0sQ0FBQyxDQUFDLGNBQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFDLENBQUMsRUFBRSxDQUFDLEVBQUMsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNmLENBQUM7Q0FDSjtBQW5CRCxzQ0FtQkM7QUFFRCxJQUFZLFdBQW1DO0FBQS9DLFdBQVksV0FBVztJQUFHLDZDQUFRLENBQUE7SUFBRSwrQ0FBUyxDQUFBO0FBQUMsQ0FBQyxFQUFuQyxXQUFXLEdBQVgsbUJBQVcsS0FBWCxtQkFBVyxRQUF3QjtBQWEvQyxtQkFBaUMsU0FBUSxrQ0FBd0M7SUFRN0UsWUFBWSxXQUFxQyxFQUFFLE9BQXdCLEVBQUUsT0FBd0IsRUFBRSxJQUFJO1FBQ3ZHLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQU5SLGdCQUFXLEdBQUcsSUFBSSxpQkFBaUIsRUFBSyxDQUFDO1FBQ3pDLGlCQUFZLEdBQUcsSUFBSSxpQkFBaUIsRUFBSyxDQUFDO1FBTTlDLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQzNCLENBQUM7SUFFRCxLQUFLLENBQUMsRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFRLEVBQUUsSUFBc0M7UUFDN0QsSUFBSSxDQUFDLEdBQW9DLEVBQUUsQ0FBQztRQUM1QyxJQUFJLE1BQU0sR0FBRyxDQUFDLENBQWtDLEVBQVcsRUFBRTtZQUN6RCxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQztRQUN4QyxDQUFDLENBQUM7UUFDRixJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFO1lBQ2hCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUFDLENBQUM7WUFDMUIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDWixJQUFJLENBQUMsSUFBSSxFQUEwQixDQUFDLENBQUMsQ0FBQztZQUMxQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ3JDLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQ1osT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDdEMsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDWixPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDZixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxVQUFVLENBQUMsQ0FBTSxFQUFFLFFBQVEsRUFBRSxFQUFFO1FBQzNCLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9DLElBQUksQ0FBQyxPQUFPLENBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQixJQUFJLENBQUMsT0FBTyxDQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDZixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFBQyxDQUFDLENBQUMsb0JBQW9CO1lBQzdDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQXlCLEVBQUUsRUFBRTtnQkFDN0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUFDLENBQUMsQ0FBQyxvQkFBb0I7Z0JBQzdDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2IsRUFBRSxFQUFFLENBQUM7WUFDVCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQztRQUNGLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDMUMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFJLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM5QyxDQUFDO1FBQ0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUksQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3hDLENBQUM7Q0FFSjtBQXZERCxzQ0F1REM7QUFFRCx3QkFBNEMsU0FBUSxrQ0FBb0M7SUFNcEYsWUFBWSxLQUF3QixFQUFFLE9BQW9CLEVBQUUsSUFBSTtRQUM1RCxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFMUixnQkFBVyxHQUFHLElBQUksYUFBYSxFQUFRLENBQUM7UUFNNUMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDM0IsQ0FBQztJQUVELFVBQVUsQ0FBQyxDQUF5QixFQUFFLFFBQVEsRUFBRSxFQUFFO1FBRTlDLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFTLEVBQUUsRUFBaUIsRUFBRSxFQUFFO1lBQy9DLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQVMsRUFBRSxFQUFFO2dCQUNyQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsQ0FBQztnQkFDeEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBQUMsQ0FBQztnQkFDeEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFO29CQUM3QixFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbEIsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQztRQUVGLElBQUksS0FBSyxHQUFJLGFBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM3QixxQkFBUSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBUyxFQUFFLEVBQUU7WUFDckMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQUMsQ0FBQztZQUN4QixFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hCLGVBQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtvQkFDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDakIsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDO1lBQ0QsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsMEJBQTBCO0lBQzlCLENBQUM7Q0FDSjtBQXRDRCxnREFzQ0MifQ==